{"version":3,"file":"ts-async-queue.es5.js","sources":["../src/queueError.ts","../src/taskQueue.ts"],"sourcesContent":["import { TaskQueue } from './taskQueue';\n\n/**\n * An error raised during the queue execution\n */\nexport class QueueError<T> extends Error {\n  constructor(\n    message: string,\n    public readonly queue: TaskQueue,\n    public data?: T\n  ) {\n    super(message)/* istanbul ignore next: because stupid typescript */;\n    Object.setPrototypeOf(this, QueueError.prototype);\n    this.name = 'QueueError';\n  }\n\n  toString() {\n    return this.name + ': ' + this.message;\n  }\n}\n","import { QueueError } from './queueError';\n\n/**\n * A function that returns promise and has no arguments\n */\nexport type Task = () => Promise<any>;\n\n/**\n * Manages a queue of async tasks\n *\n * @class TaskQueue\n */\nexport class TaskQueue {\n  /**\n   * Creates an instance of TaskQueue.\n   * @param {Task[]} [tasks=[]] Tasklist\n   */\n  constructor(\n    /**\n     * Tasklist\n     */\n    protected tasks: Task[] = []\n  ) {}\n  /**\n   * The most recent running queue\n   */\n  protected lastQueue?: Promise<any[]>;\n\n  /**\n   * Results of a last queue execution\n   */\n  protected _lastResults?: any[];\n\n  /**\n   * Results of a last queue execution\n   */\n  public get lastResults() {\n    return this._lastResults && this._lastResults.slice();\n  }\n\n\n  /**\n   * `true` if the queue is running\n   */\n  protected running: boolean = false;\n\n\n  /**\n   * `true` if the queue is running\n   */\n  public get isRunning() {\n    return this.running;\n  }\n\n  /**\n   * An index at which the queue was paused\n   */\n  protected pauseIndex: number = -1;\n\n  /**\n   * Remove a task from queue by its index\n   *\n   * @returns a removed task if found\n   */\n  protected dequeueByIndex(index: number) {\n    if (index === this.length - 1) {\n      return this.tasks.pop();\n    }\n\n    if (index > -1 && this.tasks[index]) {\n      const task = this.tasks[index];\n      this.tasks.splice(index, 1);\n\n      return task;\n    }\n\n    return undefined;\n  }\n\n  /**\n   * Remove a task from queue by its reference. If no task was given, removes the last task.\n   * @param {T} [task] a reference to the task function to remove by\n   * @returns a removed task if found\n   */\n  protected dequeueByTask<T extends Task>(task?: T) {\n    if (!task) {\n      return this.tasks.pop();\n    }\n\n    const index = this.tasks.findIndex(t => t === task);\n\n    return this.dequeueByIndex(index);\n  }\n\n  /**\n   * Start executing the queue from a certain point.\n   * Halts if `running` flag is off (pause has occured).\n   *\n   * If any error in any task is raised - pauses queue execution and throws the error upstack.\n   *\n   * @param {number} from a point to execute a queue from\n   * @param {Array<any>} last saved results to add to\n   * @returns a promise that resolves to task results array when the queue is finished\n   */\n  protected async launchFrom(from: number, lastResults: any[] = []) {\n    this._lastResults = lastResults;\n    const tasks = this.tasks.slice(from);\n\n    this.running = true;\n    this.pauseIndex = -1;\n\n    for (let i = 0, task = tasks[i]; i < tasks.length; i++, task = tasks[i]) {\n      if (!this.running) {\n        this.pauseIndex = i;\n        break;\n      }\n\n      try {\n        this._lastResults.push(await task());\n      } catch (e) {\n        this.pauseIndex = i;\n        this.running = false;\n        throw new QueueError(`Queue paused at task #${i + 1} due to error in handler ${task}`, this, e);\n      }\n    }\n\n    this.running = false;\n\n    return this._lastResults.slice();\n  }\n\n  /**\n   * Adds one or more tasks to queue.\n   */\n  public enqueue<T extends Task>(...tasks: T[]) {\n    this.tasks.push.apply(this.tasks, tasks);\n  }\n\n  /**\n   * Removes task from the queue.\n   * @returns a removed task if found\n   */\n  public dequeue<T extends Task>(task?: T): Task | undefined;\n  public dequeue(index: number): Task | undefined;\n  public dequeue(): Task | undefined {\n    const arg = arguments[0];\n\n    if (typeof arg === 'number') {\n      return this.dequeueByIndex(arg);\n    } else if (typeof arg === 'function' || !arg) {\n      return this.dequeueByTask(arg);\n    }\n\n    throw new TypeError('Argument\\'s type must either be number, function or undefined!');\n  }\n\n  /**\n   * Removes the last task from the queue.\n   * @returns a removed task if found\n   */\n  public pop() {\n    return this.dequeue();\n  }\n\n  /**\n   * Get last added task without mutating the queue\n   */\n  public peek() {\n    return this.tasks[this.tasks.length - 1];\n  }\n\n\n  /**\n   * Last added task\n   */\n  public get last() {\n    return this.peek();\n  }\n\n  /**\n   * Queue length\n   */\n  public get length() {\n    return this.tasks.length;\n  }\n\n  /**\n   * Completely clears the queue and stops executions.\n   *\n   * If the queue is currently running it is recommended to call `await pause()` first!\n   */\n  public clear() {\n    this.pauseIndex = -1;\n    this.lastQueue = undefined;\n    this.tasks.splice(0);\n  }\n\n  /**\n   * Pauses the queue's execution flow after a nearest task is completed.\n   *\n   * @returns a promise that resolves as soon as the queue is paused\n   */\n  public pause() {\n    this.running = false;\n\n    return this.lastQueue;\n  }\n\n  /**\n   * Resumes a previously paused queue.\n   *\n   * @returns a promise that resolves as soon as the queue is completed\n   */\n  public resume() {\n    return this.lastQueue = this.launchFrom(this.pauseIndex, this._lastResults);\n  }\n\n  /**\n   * Stops queue execution and clears results.\n   *\n   * @returns a promise that resolves to queue results (or `undefined` if the queue has already been stopeed) as soon as the queue completely stops executing\n   */\n  public async stop() {\n    await this.pause();\n    this.pauseIndex = -1;\n    this.lastQueue = undefined;\n    const results = this.lastResults;\n\n    if (this._lastResults) {\n      this._lastResults = undefined;\n    }\n\n    return results;\n  }\n\n  /**\n   * Starts task queue execution.\n   *\n   * Returns currenlty executed queue if execution already started\n   *\n   * @returns promise with task results as an array sorted by task execution order\n   */\n  public start() {\n    if (this.lastQueue) {\n      return this.lastQueue;\n    }\n\n    return this.lastQueue = this.launchFrom(0);\n  }\n}\n"],"names":["tslib_1.__extends"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA;;;AAGA;IAAmCA,8BAAK;IACtC,oBACE,OAAe,EACC,KAAgB,EACzB,IAAQ;QAHjB,YAKE,kBAAM,OAAO,CAAC,+DAGf;QANiB,WAAK,GAAL,KAAK,CAAW;QACzB,UAAI,GAAJ,IAAI,CAAI;QAGf,MAAM,CAAC,cAAc,CAAC,KAAI,EAAE,UAAU,CAAC,SAAS,CAAC,CAAC;QAClD,KAAI,CAAC,IAAI,GAAG,YAAY,CAAC;;KAC1B;IAED,6BAAQ,GAAR;QACE,OAAO,IAAI,CAAC,IAAI,GAAG,IAAI,GAAG,IAAI,CAAC,OAAO,CAAC;KACxC;IACH,iBAAC;CAAA,CAdkC,KAAK;;ACExC;;;;;AAKA;;;;;IAKE;;;;IAIY,KAAkB;QAAlB,sBAAA,EAAA,UAAkB;QAAlB,UAAK,GAAL,KAAK,CAAa;;;;QAuBpB,YAAO,GAAY,KAAK,CAAC;;;;QAazB,eAAU,GAAW,CAAC,CAAC,CAAC;KAnC9B;IAcJ,sBAAW,kCAAW;;;;aAAtB;YACE,OAAO,IAAI,CAAC,YAAY,IAAI,IAAI,CAAC,YAAY,CAAC,KAAK,EAAE,CAAC;SACvD;;;OAAA;IAYD,sBAAW,gCAAS;;;;aAApB;YACE,OAAO,IAAI,CAAC,OAAO,CAAC;SACrB;;;OAAA;;;;;;IAYS,kCAAc,GAAxB,UAAyB,KAAa;QACpC,IAAI,KAAK,KAAK,IAAI,CAAC,MAAM,GAAG,CAAC,EAAE;YAC7B,OAAO,IAAI,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC;SACzB;QAED,IAAI,KAAK,GAAG,CAAC,CAAC,IAAI,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,EAAE;YACnC,IAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;YAC/B,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC;YAE5B,OAAO,IAAI,CAAC;SACb;QAED,OAAO,SAAS,CAAC;KAClB;;;;;;IAOS,iCAAa,GAAvB,UAAwC,IAAQ;QAC9C,IAAI,CAAC,IAAI,EAAE;YACT,OAAO,IAAI,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC;SACzB;QAED,IAAM,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,UAAA,CAAC,IAAI,OAAA,CAAC,KAAK,IAAI,GAAA,CAAC,CAAC;QAEpD,OAAO,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC;KACnC;;;;;;;;;;;IAYe,8BAAU,GAA1B,UAA2B,IAAY,EAAE,WAAuB;QAAvB,4BAAA,EAAA,gBAAuB;;;;;;wBAC9D,IAAI,CAAC,YAAY,GAAG,WAAW,CAAC;wBAC1B,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;wBAErC,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC;wBACpB,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC,CAAC;wBAEZ,CAAC,GAAG,CAAC,EAAE,IAAI,GAAG,KAAK,CAAC,CAAC,CAAC;;;8BAAE,CAAC,GAAG,KAAK,CAAC,MAAM,CAAA;wBAC/C,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE;4BACjB,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC;4BACpB,wBAAM;yBACP;;;;wBAGC,KAAA,CAAA,KAAA,IAAI,CAAC,YAAY,EAAC,IAAI,CAAA;wBAAC,qBAAM,IAAI,EAAE,EAAA;;wBAAnC,cAAuB,SAAY,EAAC,CAAC;;;;wBAErC,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC;wBACpB,IAAI,CAAC,OAAO,GAAG,KAAK,CAAC;wBACrB,MAAM,IAAI,UAAU,CAAC,4BAAyB,CAAC,GAAG,CAAC,kCAA4B,IAAM,EAAE,IAAI,EAAE,GAAC,CAAC,CAAC;;wBAXjD,CAAC,EAAE,EAAE,IAAI,GAAG,KAAK,CAAC,CAAC,CAAC,CAAA;;;wBAevE,IAAI,CAAC,OAAO,GAAG,KAAK,CAAC;wBAErB,sBAAO,IAAI,CAAC,YAAY,CAAC,KAAK,EAAE,EAAC;;;;KAClC;;;;IAKM,2BAAO,GAAd;QAA+B,eAAa;aAAb,UAAa,EAAb,qBAAa,EAAb,IAAa;YAAb,0BAAa;;QAC1C,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC;KAC1C;IAQM,2BAAO,GAAd;QACE,IAAM,GAAG,GAAG,SAAS,CAAC,CAAC,CAAC,CAAC;QAEzB,IAAI,OAAO,GAAG,KAAK,QAAQ,EAAE;YAC3B,OAAO,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,CAAC;SACjC;aAAM,IAAI,OAAO,GAAG,KAAK,UAAU,IAAI,CAAC,GAAG,EAAE;YAC5C,OAAO,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,CAAC;SAChC;QAED,MAAM,IAAI,SAAS,CAAC,gEAAgE,CAAC,CAAC;KACvF;;;;;IAMM,uBAAG,GAAV;QACE,OAAO,IAAI,CAAC,OAAO,EAAE,CAAC;KACvB;;;;IAKM,wBAAI,GAAX;QACE,OAAO,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;KAC1C;IAMD,sBAAW,2BAAI;;;;aAAf;YACE,OAAO,IAAI,CAAC,IAAI,EAAE,CAAC;SACpB;;;OAAA;IAKD,sBAAW,6BAAM;;;;aAAjB;YACE,OAAO,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;SAC1B;;;OAAA;;;;;;IAOM,yBAAK,GAAZ;QACE,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC,CAAC;QACrB,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;QAC3B,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;KACtB;;;;;;IAOM,yBAAK,GAAZ;QACE,IAAI,CAAC,OAAO,GAAG,KAAK,CAAC;QAErB,OAAO,IAAI,CAAC,SAAS,CAAC;KACvB;;;;;;IAOM,0BAAM,GAAb;QACE,OAAO,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,YAAY,CAAC,CAAC;KAC7E;;;;;;IAOY,wBAAI,GAAjB;;;;;4BACE,qBAAM,IAAI,CAAC,KAAK,EAAE,EAAA;;wBAAlB,SAAkB,CAAC;wBACnB,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC,CAAC;wBACrB,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;wBACrB,OAAO,GAAG,IAAI,CAAC,WAAW,CAAC;wBAEjC,IAAI,IAAI,CAAC,YAAY,EAAE;4BACrB,IAAI,CAAC,YAAY,GAAG,SAAS,CAAC;yBAC/B;wBAED,sBAAO,OAAO,EAAC;;;;KAChB;;;;;;;;IASM,yBAAK,GAAZ;QACE,IAAI,IAAI,CAAC,SAAS,EAAE;YAClB,OAAO,IAAI,CAAC,SAAS,CAAC;SACvB;QAED,OAAO,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;KAC5C;IACH,gBAAC;CAAA;;;;;"}