{"version":3,"file":"ts-async-queue.es5.js","sources":["../src/index.ts"],"sourcesContent":["/**\n * TODO:\n *\n * - Tasks complete syncronyously\n * - Ability to choose a specific queue for the task: labels/ids?\n * - Choose queue priority?\n */\n\n\nexport type Task = () => Promise<any>;\n\n// TODO: add newly launched queues to the map\n// type PriorityMap = {\n//   [id: string]: TaskQueue;\n// };\n// const queues: PriorityMap = {};\n\nexport class TaskQueue {\n  private runningQueue?: Promise<any[]>;\n  private running: boolean = false;\n  private pauseIndex: number = -1;\n\n  private dequeueByIndex(index: number) {\n    if (index === this.length - 1) {\n      return this.tasks.pop();\n    }\n\n    if (index > -1) {\n      const task = this.tasks[index];\n      this.tasks.splice(index, 1);\n\n      return task;\n    }\n\n    return undefined;\n  }\n\n  private dequeueByTask<T extends Task>(task?: T) {\n    if (!task) {\n      return this.tasks.pop();\n    }\n\n    const index = this.tasks.findIndex(t => t === task);\n\n    this.dequeueByIndex(index);\n\n    return task;\n  }\n\n  private async launchFrom(from: number) {\n    const results: any[] = [];\n    const entries = this.tasks.slice(from).entries();\n\n    for (const [index, task] of entries) {\n      if (!this.running) {\n        this.pauseIndex = index;\n        break;\n      }\n\n      try {\n        results.push(await task());\n      } catch (e) {\n        this.pause();\n        throw new QueueError(`Queue paused at task #${index} due to error in handler ${task}`, e);\n      }\n    }\n\n    return results;\n  }\n\n  constructor(private tasks: Task[] = []) {}\n\n  public enqueue<T extends Task>(...tasks: T[]) {\n    this.tasks.push.apply(this.tasks, tasks);\n  }\n\n  public dequeue<T extends Task>(task?: T);\n  public dequeue(index: number);\n  public dequeue() {\n    const arg = arguments[0];\n\n    if (typeof arg === 'number') {\n      return this.dequeueByIndex(arg);\n    } else {\n      return this.dequeueByTask(arg);\n    }\n  }\n\n  public peek() {\n    return this.tasks[this.tasks.length - 1];\n  }\n\n  public get last() {\n    return this.peek();\n  }\n\n  public get length() {\n    return this.tasks.length;\n  }\n\n  public clear() {\n    this.tasks.splice(0);\n  }\n\n  public pause() {\n    this.running = false;\n\n    return this.runningQueue;\n  }\n\n  public resume() {\n    this.runningQueue = this.launchFrom(this.pauseIndex);\n  }\n\n  public stop() {\n    this.pause();\n    this.pauseIndex = -1;\n    this.runningQueue = undefined;\n  }\n\n  public start() {\n    if (this.runningQueue) {\n      return this.runningQueue;\n    }\n\n    return this.runningQueue = this.launchFrom(0);\n  }\n}\n\nexport class QueueError<T> extends Error {\n  constructor(\n    message: string,\n    public data?: T\n  ) {\n    super(message)/* istanbul ignore next: because stupid typescript */;\n    Object.setPrototypeOf(this, QueueError.prototype);\n    this.name = 'ResponseException';\n  }\n\n  toString() {\n    return this.name + ': ' + this.message;\n  }\n}\n"],"names":["tslib_1.__values","tslib_1.__read","tslib_1.__extends"],"mappings":"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"}